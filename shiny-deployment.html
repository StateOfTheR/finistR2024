<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.555">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Cédric Midoux, Pierre Neuvial, Aymeric Stamm, Emily Walker">

<title>Finist’R 2024 - Solutions institutionnelles de déploiement d’applications shiny avec kubernetes</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">Finist’R 2024</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/StateOfTheR/finistR2024"> <i class="bi bi-github" role="img" aria-label="GitHub">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./instructions.html"> 
<span class="menu-text">Instructions</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="./plotting_with_julia-1.html"> 
<span class="menu-text">Graphiques avec Julia</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-algorithme" role="button" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Algorithme</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-algorithme">    
        <li>
    <a class="dropdown-item" href="./01_nimble.html">
 <span class="dropdown-text">Initiation à Nimble</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./python_practice.html">
 <span class="dropdown-text">Un bon départ avec Python</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./simulator.html">
 <span class="dropdown-text">Simulations</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-développement" role="button" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Développement</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-développement">    
        <li>
    <a class="dropdown-item" href="./precommit.html">
 <span class="dropdown-text">Pre-commit avec R</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./packaging_and_testing.html">
 <span class="dropdown-text">Python packaging</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./pkg.html">
 <span class="dropdown-text">R packaging</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-réseaux-de-neurones" role="button" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Réseaux de Neurones</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-réseaux-de-neurones">    
        <li>
    <a class="dropdown-item" href="./Bipartite_GNN.html">
 <span class="dropdown-text">Graph Neural Networks for bipartite graphs with pytorch_geometric</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-déploiement" role="button" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Déploiement</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-déploiement">    
        <li>
    <a class="dropdown-item" href="./shiny-deployment.html">
 <span class="dropdown-text">Déploiement Shiny</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-high-performance-computing" role="button" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">High performance computing</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-high-performance-computing">    
        <li>
    <a class="dropdown-item" href="./futureverse.html">
 <span class="dropdown-text">futureverse</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./c_python.html">
 <span class="dropdown-text">C++ depuis Python</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./c_jax.html">
 <span class="dropdown-text">C++ depuis JAX</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="./01_extract_env_data.html"> 
<span class="menu-text">Web scrapping</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-reproductibilité" role="button" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Reproductibilité</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-reproductibilité">    
        <li>
    <a class="dropdown-item" href="./quarto_parametre.html">
 <span class="dropdown-text">Document paramétré en quarto</span></a>
  </li>  
    </ul>
  </li>
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#motivation" id="toc-motivation" class="nav-link active" data-scroll-target="#motivation"><span class="header-section-number">1</span> Motivation</a>
  <ul class="collapse">
  <li><a href="#outils-institutionnels-existants" id="toc-outils-institutionnels-existants" class="nav-link" data-scroll-target="#outils-institutionnels-existants"><span class="header-section-number">1.1</span> Outils institutionnels existants</a></li>
  <li><a href="#préparation-de-lappli-au-déploiement" id="toc-préparation-de-lappli-au-déploiement" class="nav-link" data-scroll-target="#préparation-de-lappli-au-déploiement"><span class="header-section-number">1.2</span> Préparation de l’appli au déploiement</a></li>
  <li><a href="#configuration-du-serveur-shiny" id="toc-configuration-du-serveur-shiny" class="nav-link" data-scroll-target="#configuration-du-serveur-shiny"><span class="header-section-number">1.3</span> Configuration du serveur shiny</a></li>
  <li><a href="#accessibilité" id="toc-accessibilité" class="nav-link" data-scroll-target="#accessibilité"><span class="header-section-number">1.4</span> Accessibilité ?</a></li>
  <li><a href="#autres-ressources" id="toc-autres-ressources" class="nav-link" data-scroll-target="#autres-ressources"><span class="header-section-number">1.5</span> Autres ressources</a></li>
  <li><a href="#sec-shinyapps.io" id="toc-sec-shinyapps.io" class="nav-link" data-scroll-target="#sec-shinyapps.io"><span class="header-section-number">1.6</span> Etapes du déploiement d’une application shiny via shinyapps.io</a></li>
  <li><a href="#idées-damelioration-de-la-solution-plmshift" id="toc-idées-damelioration-de-la-solution-plmshift" class="nav-link" data-scroll-target="#idées-damelioration-de-la-solution-plmshift"><span class="header-section-number">1.7</span> Idées d’amelioration de la solution PLMShift</a></li>
  <li><a href="#bibliographie" id="toc-bibliographie" class="nav-link" data-scroll-target="#bibliographie"><span class="header-section-number">1.8</span> Bibliographie</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Solutions institutionnelles de déploiement d’applications shiny avec kubernetes</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Cédric Midoux, Pierre Neuvial, Aymeric Stamm, Emily Walker </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<section id="motivation" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Motivation</h1>
<ul>
<li>besoin de déploiement d’appli <a href="https://shiny.posit.co/">shiny</a> pour utilisation sans programmation</li>
<li>solution proposée par <a href="https://www.shinyapps.io/">shinyapps.io</a>: limitation à 25h/mois et 5 applications concurrentes pour la version gratuite, et 1Gb de RAM. Les étapes du déploiement sont illustrées dans la <a href="#sec-shinyapps.io" class="quarto-xref">Section&nbsp;1.6</a></li>
<li>solution proposée par Posit (anciennement par Shiny Server Pro): <a href="https://posit.co/products/enterprise/connect/">PositConnect</a>: payant (cher)</li>
<li>intérêt d’avoir une solution institutionnelle</li>
</ul>
<section id="outils-institutionnels-existants" class="level2" data-number="1.1">
<h2 data-number="1.1" class="anchored" data-anchor-id="outils-institutionnels-existants"><span class="header-section-number">1.1</span> Outils institutionnels existants</h2>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Outil</th>
<th>Institution</th>
<th>Références</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><a href="https://plmshift.pages.math.cnrs.fr/">plmshift</a></td>
<td>CNRS</td>
<td></td>
</tr>
<tr class="even">
<td><a href="https://sk8.inrae.fr/">SK8</a></td>
<td>INRAE</td>
<td><span class="citation" data-cites="maigne:hal-04141247">Maigné et al. (<a href="#ref-maigne:hal-04141247" role="doc-biblioref">2023</a>)</span></td>
</tr>
<tr class="odd">
<td><a href="https://gitlab.pasteur.fr/hub/shiny-k8s">Shiny-K8s</a></td>
<td>Institut Pasteur</td>
<td><span class="citation" data-cites="brancotte:pasteur-04643557">Brancotte and Chapeaublanc (<a href="#ref-brancotte:pasteur-04643557" role="doc-biblioref">2024</a>)</span></td>
</tr>
</tbody>
</table>
</section>
<section id="préparation-de-lappli-au-déploiement" class="level2" data-number="1.2">
<h2 data-number="1.2" class="anchored" data-anchor-id="préparation-de-lappli-au-déploiement"><span class="header-section-number">1.2</span> Préparation de l’appli au déploiement</h2>
<p>Ces trois outils sont dédiés au déploiement d’applications shiny via <a href="https://kubernetes.io/">Kubernetes</a> (aka K8s). Le développeur de l’application shiny doit fournir un dépôt git contenant le code source de l’application et spécifier les dépendances (via un fichier csv dédié pour shiny-K8s et plmshift, ou automatiquement via renv pour SK8).</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/shinyapps-interface-01-overview.png" class="img-fluid figure-img"></p>
<figcaption>Etapes pour le déploiement d’une application shiny via SK8 (INRAE)</figcaption>
</figure>
</div>
</section>
<section id="configuration-du-serveur-shiny" class="level2" data-number="1.3">
<h2 data-number="1.3" class="anchored" data-anchor-id="configuration-du-serveur-shiny"><span class="header-section-number">1.3</span> Configuration du serveur shiny</h2>
<p>C’est ici que les trois solutions se différencient:</p>
<ul>
<li>Pour <a href="https://plmshift.pages.math.cnrs.fr/">plmshift</a>, on demande également au développeur de l’application de configurer et d’administrer lui-même son instance ShinyServer, via l’interface d’OpenShift. Ces étapes sont documentées <a href="https://plmshift.pages.math.cnrs.fr/exemples_de_deploiement/deployer_shinyr/">ici</a><br>
</li>
<li>Idem pour <a href="https://gitlab.pasteur.fr/hub/shiny-k8s">Shiny-K8s</a>, avec (semble-t-il) moins de compétences techniques requises. Ces étapes sont documentées <a href="https://hub.pages.pasteur.fr/shiny-k8s/user_guide/index.html">ici</a></li>
<li><a href="https://sk8.inrae.fr/">SK8</a> propose une interface simplifiée pour la configuration du serveur shiny, qui permet au développeur de l’application shiny spécifier directement les paramètres (RAM, CPU) sans avoir besoin de compétences en déploiement.</li>
</ul>
</section>
<section id="accessibilité" class="level2" data-number="1.4">
<h2 data-number="1.4" class="anchored" data-anchor-id="accessibilité"><span class="header-section-number">1.4</span> Accessibilité ?</h2>
<p><a href="https://plmshift.pages.math.cnrs.fr/">plmshift</a>, <a href="https://sk8.inrae.fr/">SK8</a> et <a href="https://gitlab.pasteur.fr/hub/shiny-k8s">Shiny-K8s</a> sont respectivement accessibles seulement pour des projets développés par le CNRS, INRAE et l’Institut Pasteur.</p>
<p>Aujourd’hui, SK8 semble la solution la plus simple d’utilisation pour le développeur shiny. Les paramètres de configuration sont relativement proches de ceux demandés pour le dépoiements sur shinyapps.io (voir <a href="#sec-shinyapps.io" class="quarto-xref">Section&nbsp;1.6</a>). Afin de rendre ce type d’outil accessible à d’autres institutions qu’’INRAE, on peut envisager soit l’ouverture d’un des services existants à ces institutions, soit la mise à disposition de ce type de service directement par chaque institution. Les deux solutions nécessitent des ressources matérielles et humaines; la première solution peut permettre des économies d’échelle mais peut poser des questions sur le partage des données de recherche entre institutions.</p>
</section>
<section id="autres-ressources" class="level2" data-number="1.5">
<h2 data-number="1.5" class="anchored" data-anchor-id="autres-ressources"><span class="header-section-number">1.5</span> Autres ressources</h2>
<ul>
<li><a href="https://gitlab.pasteur.fr/hub/shiny-k8s-example">code</a> d’une application démo pour déploiement avec shiny-K8s</li>
<li><a href="https://forgemia.inra.fr/elisemaigne/slides/presentation_sk8_rr2024">présentation</a> d’Elise Maigné aux rencontres R 2024</li>
</ul>
</section>
<section id="sec-shinyapps.io" class="level2" data-number="1.6">
<h2 data-number="1.6" class="anchored" data-anchor-id="sec-shinyapps.io"><span class="header-section-number">1.6</span> Etapes du déploiement d’une application shiny via shinyapps.io</h2>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/shinyapps-interface-01-overview.png" class="img-fluid figure-img"></p>
<figcaption>Vue d’ensemble</figcaption>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/shinyapps-interface-02-params-basic.png" class="img-fluid figure-img"></p>
<figcaption>Configuration: paramètres de base</figcaption>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/shinyapps-interface-03-params-advanced.png" class="img-fluid figure-img"></p>
<figcaption>Configuration: paramètres avancés</figcaption>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/shinyapps-interface-04-metrics.png" class="img-fluid figure-img"></p>
<figcaption>Statistiques d’utilisation</figcaption>
</figure>
</div>
</section>
<section id="idées-damelioration-de-la-solution-plmshift" class="level2" data-number="1.7">
<h2 data-number="1.7" class="anchored" data-anchor-id="idées-damelioration-de-la-solution-plmshift"><span class="header-section-number">1.7</span> Idées d’amelioration de la solution PLMShift</h2>
<p>La procédure de déploiement consiste à:</p>
<ol type="1">
<li><p>Préparer le code de l’application shiny dans un repository git selon un template fourni par PLMShift;</p></li>
<li><p>Créer une instance ShinyR à partir de l’interface OpenShift en:</p>
<ul>
<li>Renseignant l’adresse du repository git;</li>
<li>Configurant des secrets pour l’authentification (communication GitHub - OpenShift);</li>
<li>Configurant des variables d’environnement pour l’application (nom de l’application, ressources nécessaires etc.);</li>
<li>Configurant des paramètres de déploiement (nombre de réplicas, stratégie de déploiement etc.);</li>
<li>Configurant des paramètres de monitoring (alertes, logs etc.).</li>
</ul></li>
<li><p>Tester l’application déployée.</p></li>
</ol>
<p>Les étapes 2 et 3 sont réalisées par le développeur de l’application. L’interface OpenShift est complexe et nécessite des compétences techniques. Il serait intéressant de simplifier cette interface pour la rendre plus accessible aux utilisateurs non-experts. Par exemple, en proposant une interface graphique pour la configuration des secrets, des variables d’environnement, des paramètres de déploiement et de monitoring.</p>
</section>
<section id="bibliographie" class="level2" data-number="1.8">




</section>
</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">1.8 Bibliographie</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-brancotte:pasteur-04643557" class="csl-entry" role="listitem">
Brancotte, Bryan, and Elodie Chapeaublanc. 2024. <span>“<span class="nocase">Shiny-K8s, a toolkit to easily and reproducibly deploy your (R)Shiny app thanks to docker and Kubernetes (without mastering them!)</span>.”</span> <span>JOBIM TOULOUSE</span>; <span>JOBIM 2024</span>. <a href="https://pasteur.hal.science/pasteur-04643557">https://pasteur.hal.science/pasteur-04643557</a>.
</div>
<div id="ref-maigne:hal-04141247" class="csl-entry" role="listitem">
Maigné, Élise, Isabelle Sanchez, David Carayon, Joseph Tran, Jean-François Rey, Cédric Midoux, and Marine Marjou. 2023. <span>“<span class="nocase">SK8 : Un service institutionnel de gestion et d’h<span class="nocase">é</span>bergement d’applications Shiny</span>.”</span> <span>Rencontres R 2023 et 2024</span>. <a href="https://hal.inrae.fr/hal-04141247">https://hal.inrae.fr/hal-04141247</a>.
</div>
</div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>